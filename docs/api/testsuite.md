Test Suite
====

Overview
----

Automated testing of a cache interface is very important for rapid development -- therefore, `cachepp` includes such a testing suite with the framework.

TestSuite
----

### Template Arguments

The `TestSuite` template provides a standard way in which to test a given `CacheInterface` implementation for both correctness and performance. The template needs the 
following arguments:

* `typename X`

	The name of a fully instantiated implementation of the `CacheInterface` class (that is, where all `CacheInterface` template arguments are specified).

* `typename D`

	The associated cache data type of `X`.

* `typename T`

	The name of a fully instantiated implementation of the `LineInterface` class.

### Properties

* `std::shared_ptr<X> cache`

	A pointer to the cache which will be tested.

* `cachepp::TestResult result`

	A logger to track performance results.

### Methods

* `(constructor)`

	Creates a `TestSuite` instance with the given cache and an empty `TestResult` instance.

* `correctness(lines, n_attempts, is_parallel, n_threads)`

	Takes in an array of `lines` of type `T` and the number of attempts `n_attempts` to test **per thread**. Attempts to break `TestSuite::cache` by making repeated 
	calls to `CacheInterface::acquire` and `CacheInterface::release`. Raises `exceptionpp::InvalidOperation` on incorrect argument format, and raises 
	`exceptionpp::RuntimeError` on test failure. Calls `TestSuite::aux_correctness` to run actual tests. Calls `CacheInterface::clear`.

* `performance(tag, lines, line_size, access_pattern, access_pattern_aux, read_rate, n_attempts, is_parallel, n_threads)`

	Takes in:

	* `tag` -- three character string describing the test
	* `lines` -- an array of lines of type `T`
	* `line_size` -- the size of each line in `lines` (that is, write to each line the appropriate number of bytes)
	* `access_patten` -- a pointer to a vector of indicies of `lines` -- this represents the order by which the performance test will access `lines`
	* `access_pattern_aux` -- a pointer to a vector of `D` instances -- for each element in `access_pattern`, the associated auxiliary data to be put into 
		`CacheInterface::acquire`. If the length of `access_pattern_aux` is `0`, then the default constructor `D()` will be called for each call to 
		`CacheInterface::acquire` instead.
	* `read_rate` -- a decimal value (i.e. between `0` and `1`) of how many reads to expect in the performance test
	* `n_attempts` -- number of times to iterate through `access_pattern` **per thread**

	`CacheInterface::performance` will raise `exceptionpp::InvalidOperation` on incorrect argument format. Calls `CacheInterface::reset`. Adds a record to 
	`CacheInterface::result` upon completion of test.

* `generate_access_pattern(n_lines, length, mode)`

	Generates a `length`-sized access pattern, with each element (i.e. index) between `0` and `n_lines`. `mode` set to `0` will generate a random pattern. Currently, 
	this is the only pattern able to be generated by `TestSuite`.

### Examples

[tests/testsuite.cc](../../tests/testsuite.cc) calls on the test suite to run some unit tests, and outputs the results upon completion.

TestResult
----

The `TestResult` class keeps a record of all performance evaluations done by `TestSuite` -- these are reported `TestResult::to_string` with column names which closely 
reflect the properties below. Each property below is stored in `TestResult` as a data array, with `0` being the index of the first record stored -- that is, `tag.at(0)`
is the tag of an experiment that was run with `read_rate.at(0)`.

### Properties

* `tag`

	Three-character description of the experiment.

* `n_acquire`

	The total number of calls to the cache during the experiment.

* `total_data`

	The total number of bytes transferred during the experiment.

* `read_rate`

	The read rate of the experiment (versus write rate).

* `miss_rate`

	As reported by `CacheInterface::get_miss_rate`.

* `line_size`

	The average **capacity** of each line, in units of bytes.

* `cache_size`

	As reported by `CacheInterface::get_size`.

* `pool_size`

	The **number** of lines (i.e. `lines.size`) passed into `TestSuite::performance`.

* `total_runtime`

	The total time taken in `CacheInterface::r` and `CacheInterface::w` during the experiment, in units of microseconds (us).

* `r_time`

	average loading time (in microseconds) of the line data over `n_attempts` -- run in a separate test in `TestSuite::performance` (output column `l-time`)

* `w_time`

	average unloading time (in microseconds) of the line data over `n_attempts` -- run in a separate test in `TestSuite::performance` (output column `u-time`)


### Methods

* `get_size()`

	Returns the number of records in the logger.

* `to_string(is_tsv)`

	Returns the internal record in a formatted string. If `is_tsv` is set to `true`, returns a tab-separated string instead. Raises `exceptionpp::InvalidOperation` 
	if `TestResult::size` is `0` at the time of invocation.

Further Reading
----

* [cache interface](cacheinterface.md)
* [exceptionpp](https://github.com/cripplet/exceptionpp)
* [line interface](lineinterface.md)
* [testsuite.cc](../../src/testsuite.cc)
* [testsuite.h](../../include/src/testsuite.h)
* [testsuite.template](../../include/src/templates/testsuite.template)
